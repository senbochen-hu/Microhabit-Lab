# 微习惯实验室 - 项目任务清单

**版本**: V1.0
**创建日期**: 2025-12-26
**预计完成**: 2026-01-26 (1个月)

---

## 📊 项目进度总览

- [ ] 第一阶段: 项目搭建与基础配置 (Week 1)
- [ ] 第二阶段: 云开发后端 (Week 1)
- [ ] 第三阶段: 核心功能页面 (Week 2-3)
- [ ] 第四阶段: 会员系统 (Week 3)
- [ ] 第五阶段: 核心业务逻辑 (Week 3)
- [ ] 第六阶段: 交互优化与细节 (Week 4)
- [ ] 第七阶段: 测试与上线 (Week 4)

---

## 第一阶段: 项目搭建与基础配置

### 1.1 项目初始化
- [ ] 使用微信开发者工具创建小程序项目
- [ ] 配置 AppID 和项目名称
- [ ] 初始化微信云开发环境
- [ ] 创建标准目录结构
  ```
  /pages          # 页面目录
  /components     # 组件目录
  /utils          # 工具函数
  /styles         # 全局样式
  /cloudfunctions # 云函数
  /assets         # 静态资源
  ```
- [ ] 配置 `app.json` (页面路由、TabBar、窗口配置)
- [ ] 配置 `project.config.json`
- [ ] 创建 `sitemap.json`

### 1.2 UI设计系统
- [ ] 创建 `/styles/variables.wxss` (颜色、字体、圆角变量)
  - 主色: #4CB8A5
  - 辅助色: #4C9BFF
  - 背景色: #F7F8FA
  - 文字颜色层级
- [ ] 创建 `/styles/common.wxss` (通用样式类)
- [ ] 设计通用组件
  - [ ] 卡片组件 (habit-card)
  - [ ] 按钮组件 (custom-button)
  - [ ] 标签组件 (tag)
  - [ ] 空状态组件 (empty-state)
  - [ ] Loading组件
- [ ] 配置 TabBar (3个Tab: 今日、习惯库、数据)

---

## 第二阶段: 云开发后端

### 2.1 数据库设计与创建
- [ ] 创建 `users` 集合
  ```json
  {
    "_id": "auto",
    "openid": "string",
    "register_time": "date",
    "last_login_time": "date",
    "member_status": "number",  // 0=普通, 1=会员
    "member_expire_time": "date"
  }
  ```
- [ ] 创建 `habit_templates` 集合
  ```json
  {
    "_id": "auto",
    "name": "string",
    "category": "string",  // health/study/emotion/efficiency
    "default_trigger": "string",
    "description": "string",
    "is_active": "boolean"
  }
  ```
- [ ] 创建 `user_habits` 集合
  ```json
  {
    "_id": "auto",
    "user_id": "string",
    "template_id": "string|null",
    "name": "string",
    "trigger": "string",
    "target_times_per_day": "number",
    "start_date": "string",  // YYYY-MM-DD
    "cycle_days": "number",  // 21
    "status": "string",  // in_progress/finished
    "created_at": "date",
    "updated_at": "date"
  }
  ```
- [ ] 创建 `habit_logs` 集合
  ```json
  {
    "_id": "auto",
    "user_id": "string",
    "user_habit_id": "string",
    "date": "string",  // YYYY-MM-DD
    "times": "number",
    "created_at": "date",
    "updated_at": "date"
  }
  ```
- [ ] 设置数据库权限规则

### 2.2 云函数开发
- [ ] **initUser** - 用户初始化
  - 输入: context.OPENID
  - 输出: 用户信息 + 会员状态
  - 逻辑: 检查用户是否存在, 不存在则创建

- [ ] **getTodayHabits** - 获取今日习惯
  - 输入: 无 (从context获取openid)
  - 输出: 今日习惯列表 + 打卡状态
  - 逻辑: 查询进行中习惯 + 今日logs

- [ ] **createHabit** - 创建习惯
  - 输入: name, trigger, target_times_per_day, template_id?
  - 输出: 新习惯ID
  - 逻辑:
    - 检查会员状态与习惯数量限制
    - 创建习惯记录 (start_date=今天)

- [ ] **logHabit** - 打卡
  - 输入: user_habit_id
  - 输出: 更新后的times
  - 逻辑:
    - 查询今日log记录
    - 不存在则创建, 存在则+1 (不超过target)

- [ ] **getStats** - 获取统计数据
  - 输入: 无
  - 输出: 统计数字 + 习惯列表 + 7天数据
  - 逻辑:
    - 进行中习惯数
    - 已完成实验数
    - 计算最长连续天数

- [ ] **getHabitDetail** - 获取习惯详情
  - 输入: user_habit_id
  - 输出: 习惯信息 + 21天完成记录 + 建议
  - 逻辑:
    - 获取习惯基础信息
    - 查询21天logs
    - 计算完成率并生成建议

- [ ] **updateHabitStatus** - 更新习惯状态
  - 输入: user_habit_id, new_status, action_type
  - 输出: 更新结果
  - 逻辑:
    - 继续新一轮: 重置start_date
    - 暂停: status改为finished

- [ ] **membership** - 会员管理
  - 输入: action (check/activate/renew)
  - 输出: 会员信息
  - 逻辑:
    - 检查会员状态
    - 处理支付回调
    - 更新会员信息

### 2.3 初始数据导入
- [ ] 编写数据导入脚本
- [ ] 导入20条预设微习惯到 `habit_templates`
  - 7条健康类
  - 5条学习类
  - 4条情绪类
  - 4条效率类

---

## 第三阶段: 核心功能页面

### 3.1 今日习惯页 (pages/home/home)
- [ ] 页面结构与样式
  - [ ] 顶部日期显示
  - [ ] 鼓励语模块 (随机文案)
  - [ ] 习惯卡片列表
  - [ ] 新建习惯按钮
- [ ] 数据加载逻辑
  - [ ] onLoad调用 getTodayHabits
  - [ ] 渲染习惯列表
- [ ] 打卡功能
  - [ ] 打卡按钮点击事件
  - [ ] 调用 logHabit 云函数
  - [ ] 乐观更新UI
  - [ ] 错误处理与回滚
- [ ] 下拉刷新
- [ ] 空状态展示
- [ ] 打卡动效 (缩放+toast)

### 3.2 新建/编辑习惯页 (pages/create-habit/create-habit)
- [ ] 页面结构
  - [ ] 标题与提示文字
  - [ ] 习惯名称输入框
  - [ ] 触发器选择器
  - [ ] 频次选择器
  - [ ] 保存/取消按钮
- [ ] 表单交互
  - [ ] 输入框字数限制 (30字)
  - [ ] 触发器按钮组切换
  - [ ] "其他"触发器自定义输入
  - [ ] 频次单选
- [ ] 表单校验
  - [ ] 必填项检查
  - [ ] 名称长度检查
- [ ] 提交逻辑
  - [ ] 调用 createHabit 云函数
  - [ ] 处理会员限制提示
  - [ ] 成功后返回首页
- [ ] 编辑模式适配

### 3.3 习惯库页 (pages/habits/habits)
- [ ] Tab切换控件 (习惯库 / 我的习惯)
- [ ] **习惯库Tab**
  - [ ] 分类筛选器 (全部/健康/学习/情绪/效率)
  - [ ] 预设模板卡片列表
  - [ ] 卡片样式 (名称+触发器+描述+添加按钮)
  - [ ] 点击添加弹窗
  - [ ] 添加确认逻辑
- [ ] **我的习惯Tab**
  - [ ] 习惯列表 (所有状态)
  - [ ] 状态标签显示
  - [ ] 当前周期进度显示
  - [ ] 点击跳转详情页
  - [ ] 长按/更多菜单 (编辑/暂停)

### 3.4 习惯详情页 (pages/habit-detail/habit-detail)
- [ ] 页面结构
  - [ ] 顶部信息卡 (名称/触发器/周期)
  - [ ] 21天日历图
  - [ ] 完成率统计
  - [ ] 建议文本
  - [ ] 操作按钮
- [ ] 数据加载
  - [ ] 调用 getHabitDetail 云函数
  - [ ] 渲染21天打卡格子
- [ ] 会员功能区分
  - [ ] 免费用户: 仅显示7天 + 蒙版
  - [ ] 会员用户: 完整21天 + 备注输入
- [ ] 建议生成逻辑
  - [ ] >80%: 建议升级
  - [ ] 50-80%: 优化建议
  - [ ] <50%: 拆小建议
- [ ] 操作按钮
  - [ ] 结束实验
  - [ ] 调整习惯 (跳转编辑)

### 3.5 数据&我页 (pages/stats/stats)
- [ ] 页面结构
  - [ ] 顶部3个统计卡片
  - [ ] 习惯列表+7天小图
  - [ ] 会员模块
  - [ ] 底部设置入口
- [ ] 数据加载
  - [ ] 调用 getStats 云函数
  - [ ] 渲染统计数字
  - [ ] 渲染习惯7天图
- [ ] 会员模块
  - [ ] 非会员: 显示开通入口
  - [ ] 会员: 显示有效期
- [ ] 设置入口
  - [ ] 隐私政策
  - [ ] 关于我们
  - [ ] 意见反馈

---

## 第四阶段: 会员系统

### 4.1 会员介绍页 (pages/membership/membership)
- [ ] 页面设计
  - [ ] 标题与副标题
  - [ ] 权益对比表 (免费 vs 会员)
  - [ ] 价格展示 (6.6元/月)
  - [ ] 开通按钮
- [ ] 权益说明
  - [ ] 习惯数量对比
  - [ ] 数据视图对比
  - [ ] 完整报告对比

### 4.2 微信支付集成
- [ ] 创建支付云函数 `pay`
  - [ ] 生成预支付订单
  - [ ] 返回支付参数
- [ ] 前端调起支付
  - [ ] wx.requestPayment
  - [ ] 处理支付结果
- [ ] 支付回调处理
  - [ ] 更新会员状态
  - [ ] 设置过期时间 (+30天)
- [ ] 支付成功页面
  - [ ] 显示开通成功
  - [ ] 显示有效期
  - [ ] 返回按钮

### 4.3 权限控制逻辑
- [ ] 创建权限检查工具函数 `utils/permission.js`
  - [ ] checkHabitLimit (检查习惯数量)
  - [ ] checkMemberStatus (检查会员状态)
  - [ ] checkDataAccess (检查数据访问权限)
- [ ] 在关键位置集成权限检查
  - [ ] 创建习惯时检查数量
  - [ ] 查看完整数据时检查会员
  - [ ] 访问模板时检查权限

### 4.4 会员引导触发
- [ ] 创建第4个习惯时弹窗
- [ ] 查看21天图表时弹窗
- [ ] 数据页会员卡片常驻

---

## 第五阶段: 核心业务逻辑

### 5.1 21天实验周期管理
- [ ] 创建周期检查工具 `utils/cycle.js`
  - [ ] checkCycleEnd (检查是否结束)
  - [ ] calculateEndDate (计算结束日期)
- [ ] 周期结束弹窗组件
  - [ ] 显示完成情况
  - [ ] 三个操作按钮
- [ ] 操作处理
  - [ ] 继续新一轮: 调用 updateHabitStatus
  - [ ] 改小习惯: 跳转编辑页
  - [ ] 暂停习惯: 更新status为finished
- [ ] 自动检查逻辑
  - [ ] 在 getTodayHabits 中检查
  - [ ] 返回需要弹窗的习惯列表

### 5.2 打卡系统优化
- [ ] 防抖处理 (避免重复点击)
- [ ] 乐观更新策略
  - [ ] 立即更新UI
  - [ ] 后台调用云函数
  - [ ] 失败时回滚
- [ ] 离线打卡缓存 (可选)
- [ ] 打卡动效优化

### 5.3 统计与报告算法
- [ ] 完成率计算
  ```javascript
  完成率 = 完成天数 / 总天数 * 100%
  ```
- [ ] 连续天数算法
  ```javascript
  // 倒序遍历logs, 计算最长连续序列
  ```
- [ ] 建议生成规则
  ```javascript
  if (完成率 > 80%) return "建议升级难度"
  else if (完成率 >= 50%) return "优化时间或环境"
  else return "把动作再拆小一点"
  ```

---

## 第六阶段: 交互优化与细节

### 6.1 动效与反馈
- [ ] 打卡按钮动效 (scale 0.9 -> 1.0)
- [ ] 卡片点击态效果
- [ ] 页面切换动画
- [ ] Toast提示文案优化
  - [ ] 打卡成功: "已记录,做得很好!"
  - [ ] 创建成功: "新习惯已加入今日列表"
  - [ ] 网络错误: "网络异常,请稍后再试"

### 6.2 Loading与错误处理
- [ ] 全局Loading组件
- [ ] 加载失败重试UI
- [ ] 网络超时提示
- [ ] 数据为空占位

### 6.3 文案优化
- [ ] 鼓励语文案池 (10条)
  ```javascript
  [
    "今天,只需要完成这些小小的动作,就足够了。",
    "小小的30秒,也在一点点改变未来。",
    "不求完美,坚持一点点就好。",
    // ... 更多
  ]
  ```
- [ ] 会员引导文案
- [ ] 实验结束弹窗文案
- [ ] 各类提示性文案

### 6.4 空状态设计
- [ ] 今日无习惯
  - 插画 + "从一个小动作开始吧"
  - "去习惯库看看" 按钮
- [ ] 我的习惯为空
  - "你还没有创建任何习惯"
- [ ] 网络失败状态

---

## 第七阶段: 测试与上线

### 7.1 功能测试
- [ ] 用户登录流程测试
  - [ ] 首次登录创建用户
  - [ ] 二次登录读取信息
- [ ] 习惯管理测试
  - [ ] 创建习惯 (预设+自定义)
  - [ ] 编辑习惯
  - [ ] 删除/暂停习惯
- [ ] 打卡功能测试
  - [ ] 单次打卡
  - [ ] 多次打卡
  - [ ] 达到上限
  - [ ] 网络异常处理
- [ ] 21天周期测试
  - [ ] 周期结束检测
  - [ ] 三种操作流程
- [ ] 会员系统测试
  - [ ] 支付流程
  - [ ] 权限限制
  - [ ] 到期降级

### 7.2 兼容性测试
- [ ] Android主流机型测试
  - [ ] 华为
  - [ ] 小米
  - [ ] OPPO
  - [ ] vivo
- [ ] iOS主流机型测试
  - [ ] iPhone 12/13/14/15
- [ ] 安全区适配
  - [ ] 刘海屏
  - [ ] 底部指示器
- [ ] 字体大小适配

### 7.3 性能优化
- [ ] 首屏加载时间优化
- [ ] 图片资源压缩
- [ ] 云函数响应时间优化
- [ ] 数据库查询优化 (索引)

### 7.4 上线准备
- [ ] 编写《隐私政策》
- [ ] 编写《用户协议》
- [ ] 小程序信息配置
  - [ ] 名称: 微习惯实验室
  - [ ] 简介
  - [ ] 类目: 健康管理
  - [ ] 标签
- [ ] 截图与宣传图
- [ ] 提交微信审核
- [ ] 灰度发布 (5%-10%)
- [ ] 全量发布

---

## 🎯 关键里程碑时间节点

| 阶段 | 完成日期 | 里程碑 |
|------|---------|--------|
| 第1周 | 2026-01-02 | ✅ 完成项目搭建与云开发配置 |
| 第2周 | 2026-01-09 | ✅ 完成今日习惯页核心打卡流程 |
| 第3周 | 2026-01-16 | ✅ 完成所有页面与会员系统 |
| 第4周 | 2026-01-23 | ✅ 完成测试并提交审核 |
| 上线 | 2026-01-26 | 🚀 正式上线 |

---

## 📝 开发规范

### 命名规范
- 页面文件夹: kebab-case (如 `habit-detail`)
- 云函数: camelCase (如 `getTodayHabits`)
- 组件: kebab-case (如 `habit-card`)
- 变量: camelCase
- 常量: UPPER_SNAKE_CASE

### 注释规范
- 云函数必须添加函数说明注释
- 复杂逻辑添加注释说明
- 组件添加使用说明

### 代码审查清单
- [ ] 错误处理是否完善
- [ ] 是否有内存泄漏风险
- [ ] 是否考虑了边界情况
- [ ] 代码是否可复用
- [ ] 性能是否可优化

---

## 🔧 技术栈总结

- **前端**: 微信小程序原生开发 (WXML/WXSS/JS)
- **后端**: 微信云开发 (云函数 Node.js + 云数据库)
- **支付**: 微信支付 (小程序虚拟支付)
- **开发工具**: 微信开发者工具
- **版本控制**: Git

---

## 📞 支持与反馈

开发过程中遇到问题可参考:
- 微信小程序官方文档: https://developers.weixin.qq.com/miniprogram/dev/
- 微信云开发文档: https://developers.weixin.qq.com/miniprogram/dev/wxcloud/
- 项目PRD文档: `微习惯实验室-需求文档-V1.0.md`
- UI设计文档: `UI.md`
