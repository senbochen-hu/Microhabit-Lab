# 微习惯实验室 - 部署指南

## 🎯 当前项目状态

✅ **已完成**:
- 项目基础框架搭建
- AppID配置完成: `wxd7b17df348c02834`
- 云环境ID配置: `cloud1-0g29mlsv3d4ca637`
- 6个页面创建完成(3个核心页面 + 3个基础页面)
- 9个云函数创建完成
- 全局样式系统和工具函数库

## 📋 部署步骤

### 第一步: 打开项目

1. 启动微信开发者工具
2. 选择"导入项目"
3. 项目目录选择: `d:\AABBCC`
4. AppID已配置: `wxd7b17df348c02834`

### 第二步: 开通云开发

1. 点击开发者工具顶部"云开发"按钮
2. 如果已有环境,确认环境ID为: `cloud1-0g29mlsv3d4ca637`
3. 如果没有环境,创建新环境并更新 `app.js` 中的环境ID

### 第三步: 创建数据库集合

在云开发控制台 → 数据库中创建以下集合:

#### 1. users (用户表)
```javascript
// 无需手动插入数据,首次登录自动创建
```

**权限设置**:
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

#### 2. habit_templates (习惯模板表)
需要导入初始数据,参考 `微习惯实验室-首发微习惯库20条.md`

**权限设置**:
```json
{
  "read": true,
  "write": false
}
```

**导入数据方法**:
- 方式A: 在云开发控制台手动添加
- 方式B: 使用导入工具(推荐,见下文)

#### 3. user_habits (用户习惯表)
```javascript
// 用户创建习惯时自动写入
```

**权限设置**:
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

#### 4. habit_logs (打卡记录表)
```javascript
// 用户打卡时自动写入
```

**权限设置**:
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

### 第四步: 部署云函数

需要部署的云函数列表:
1. `initUser` - 用户初始化
2. `getTodayHabits` - 获取今日习惯
3. `createHabit` - 创建习惯
4. `logHabit` - 打卡
5. `getStats` - 获取统计数据
6. `getHabitDetail` - 获取习惯详情
7. `updateHabitStatus` - 更新习惯状态
8. `createPayment` - 创建支付订单
9. `activateMembership` - 支付回调后激活会员
10. `initTemplates` - 导入模板数据(用完可删)

**部署方法**:
1. 在开发者工具左侧找到 `cloudfunctions` 目录
2. 右键点击每个云函数文件夹
3. 选择"上传并部署:云端安装依赖"
4. 等待部署完成

### 第五步: 导入习惯模板数据

创建临时云函数导入数据:

#### 方法A: 使用云开发控制台

在云开发控制台 → 数据库 → habit_templates → 添加记录

每条记录格式:
```json
{
  "name": "每天早上刷牙后喝 1 大口水",
  "category": "health",
  "default_trigger": "刷牙后",
  "description": "补充夜间流失的水分,帮助身体"启动新的一天"。",
  "is_active": true,
  "created_at": {
    "$date": "2025-12-26T00:00:00.000Z"
  }
}
```

#### 方法B: 创建导入云函数(推荐)

1. 创建 `cloudfunctions/initTemplates` 文件夹
2. 创建 `index.js` 和 `package.json`
3. 上传并部署
4. 在云开发控制台 → 云函数 → initTemplates → 测试
5. 执行一次后删除该云函数

### 第六步: 测试功能

#### 基础功能测试清单

- [ ] 打开小程序,检查是否正常初始化
- [ ] 查看"今日习惯"页,应该显示空状态
- [ ] 点击"去习惯库看看",查看习惯模板列表
- [ ] 从模板创建一个习惯
- [ ] 回到今日习惯页,查看是否显示新创建的习惯
- [ ] 点击打卡按钮,查看是否成功
- [ ] 切换到"我的习惯"Tab,查看习惯列表
- [ ] 查看"数据"页统计信息

#### 支付功能(如需)

- 在云开发控制台绑定商户号/密钥, 配置支付回调域名
- 在云函数环境变量添加 `SUB_MCH_ID` = 子商户号
- 部署 `createPayment` 与 `activateMembership`
- 在会员页点击开通/续费验证支付调用
- 未配置商户号时, 会员页会提示“待配置商户”, 支付按钮禁用, 不会发起支付

## 🔧 常见问题排查

### 1. 云函数调用失败

**症状**: 提示"云函数不存在"或"errCode: -1"

**排查步骤**:
1. 检查云函数是否已成功部署
2. 在云开发控制台 → 云函数中查看函数列表
3. 确认环境ID是否正确
4. 查看云函数日志排查错误

**解决方案**:
```bash
# 重新部署云函数
右键云函数文件夹 → 上传并部署:云端安装依赖
```

### 2. 数据库权限错误

**症状**: 提示"permission denied"或"无权限"

**排查步骤**:
1. 检查数据库集合是否创建
2. 检查权限规则是否正确设置
3. 确认用户是否已登录(有openid)

**解决方案**:
```javascript
// 在云开发控制台 → 数据库 → 集合名 → 权限设置
// 设置为上述推荐的权限规则
```

### 3. 空状态不显示模板

**症状**: 习惯库页面空白

**原因**: 未导入习惯模板数据

**解决方案**:
按照"第五步"导入20条习惯模板数据

### 4. 页面样式异常

**症状**: 页面布局错乱或样式不生效

**排查步骤**:
1. 检查 `app.wxss` 是否正确导入全局样式
2. 检查 `variables.wxss` 和 `common.wxss`
3. 清除缓存重新编译

**解决方案**:
```bash
# 在开发者工具中
工具 → 清除缓存 → 清除全部 → 重新编译
```

## 📊 数据库索引优化(可选)

为提升性能,建议创建以下索引:

### users 集合
- 字段: `_openid` (唯一索引)

### user_habits 集合
- 复合索引: `_openid` + `status` (升序)
- 单字段索引: `start_date` (升序)

### habit_logs 集合
- 复合索引: `user_habit_id` + `date` (唯一索引)
- 单字段索引: `_openid` (升序)

## 🚀 发布前检查清单

### 代码检查
- [ ] 所有云函数已部署
- [ ] 数据库集合已创建
- [ ] 习惯模板数据已导入
- [ ] 数据库权限已正确设置

### 功能测试
- [ ] 用户登录正常
- [ ] 创建习惯功能正常
- [ ] 打卡功能正常
- [ ] 数据统计正常
- [ ] 21天周期逻辑正常

### 体验优化
- [ ] 所有页面加载流畅
- [ ] 无明显卡顿
- [ ] 错误提示友好
- [ ] 空状态提示清晰

### 合规检查
- [ ] 隐私政策已完善
- [ ] 用户协议已完善
- [ ] 小程序名称和简介符合规范
- [ ] 服务类目选择正确

## 📝 提交审核

### 1. 小程序信息配置

在微信公众平台配置:
- **名称**: 微习惯实验室
- **简介**: 基于行为科学的微习惯养成工具,通过21天实验帮你改善生活
- **类目**: 生活服务 → 健康管理
- **标签**: 习惯养成、健康、自我提升

### 2. 版本管理

```
版本号: 1.0.0
版本描述:
- 支持创建和管理微习惯
- 21天实验周期管理
- 每日打卡功能
- 数据统计展示
```

### 3. 上传代码

1. 点击开发者工具右上角"上传"
2. 填写版本号和备注
3. 上传成功后,在微信公众平台查看

### 4. 提交审核

1. 登录微信公众平台
2. 开发管理 → 开发版本
3. 选择刚上传的版本 → 提交审核
4. 填写审核信息
5. 等待审核(通常1-3天)

## 📱 测试建议

### 体验版测试

1. 在开发者工具中上传代码
2. 在微信公众平台设置体验版
3. 生成体验版二维码
4. 邀请朋友扫码测试
5. 收集反馈并优化

### 真机调试

1. 使用真实手机扫码
2. 测试各种机型(Android/iOS)
3. 测试不同网络环境
4. 检查性能表现

## 🎉 部署完成后

恭喜!你的微习惯实验室小程序已经准备就绪!

**后续优化建议**:
1. 完善习惯详情页的21天日历图
2. 实现会员支付功能
3. 优化数据统计算法
4. 添加更多习惯模板
5. 收集用户反馈持续改进

---

**部署文档版本**: V1.0
**最后更新**: 2025-12-26
**技术支持**: 查看 README.md 和 DATABASE_DESIGN.md
