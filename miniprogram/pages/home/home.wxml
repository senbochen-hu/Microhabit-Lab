<!-- ä»Šæ—¥ä¹ æƒ¯é¡µ -->
<view class="container">
  <!-- é¡¶éƒ¨æ—¥æœŸå’Œé¼“åŠ±è¯­ -->
  <view class="header">
    <view class="date">{{dateDisplay}}</view>
    <view class="encouragement">{{encouragementText}}</view>
  </view>

  <!-- å…¨éƒ¨å®Œæˆæç¤º -->
  <view class="completed-banner" wx:if="{{showCompletedAnimation}}">
    <view class="completed-icon">ğŸ‰</view>
    <view class="completed-text">å¤ªæ£’äº†ï¼ä»Šå¤©çš„å¾®ä¹ æƒ¯å…¨éƒ¨å®Œæˆ!</view>
  </view>

  <!-- åŠ è½½ä¸­ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="spinner"></view>
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>

  <!-- åŠ è½½å¤±è´¥ -->
  <view class="error-state" wx:if="{{loadError && !loading}}">
    <view class="error-icon">âš ï¸</view>
    <view class="error-text">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</view>
    <button class="btn btn-primary mt-lg" bindtap="retryLoadTodayHabits">é‡æ–°åŠ è½½</button>
  </view>

  <!-- ä¹ æƒ¯åˆ—è¡¨ -->
  <view class="habits-container" wx:if="{{habits.length > 0 && !loading && !loadError}}">
    <view class="habit-card" wx:for="{{habits}}" wx:key="_id">
      <view class="habit-main">
        <!-- å·¦ä¾§:å®Œæˆå›¾æ ‡ -->
        <view class="check-icon" wx:if="{{item.is_completed}}">
          <image src="/assets/icons/check.png" mode="aspectFit" />
        </view>
        <view class="check-placeholder" wx:else></view>

        <!-- ä¸­é—´:ä¹ æƒ¯ä¿¡æ¯ -->
        <view class="habit-info">
          <view class="habit-name {{item.is_completed ? 'completed' : ''}}">{{item.name}}</view>
          <view class="habit-meta">
            <view class="trigger-tag tag-primary">è§¦å‘: {{item.trigger}}</view>
            <view class="progress-text">ä»Šæ—¥è¿›åº¦ {{item.today_times}}/{{item.target_times_per_day}}</view>
          </view>
        </view>

        <!-- å³ä¾§:æ‰“å¡æŒ‰é’® -->
        <view class="check-in-btn {{item.is_completed ? 'disabled' : ''}} {{checkingInId === item._id ? 'loading' : ''}}"
              bindtap="handleCheckIn"
              data-id="{{item._id}}"
              data-completed="{{item.is_completed}}">
          <view wx:if="{{checkingInId === item._id}}" class="btn-spinner"></view>
          <image wx:else src="/assets/icons/{{item.is_completed ? 'check-circle-filled.png' : 'check-circle.png'}}" mode="aspectFit" />
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{habits.length === 0 && !loading && !loadError}}">
    <view class="empty-icon">ğŸ“</view>
    <view class="empty-text">ä»Šå¤©è¿˜æ²¡æœ‰è¦åšçš„å¾®ä¹ æƒ¯</view>
    <view class="empty-sub">ä»ä¸€ä¸ªå°åŠ¨ä½œå¼€å§‹å§</view>
    <button class="btn btn-primary mt-lg" bindtap="goToHabits">å»ä¹ æƒ¯åº“çœ‹çœ‹</button>
  </view>

  <!-- å‘¨æœŸç»“æŸå¼¹çª— -->
  <view class="modal-mask" wx:if="{{showEndModal}}" catchtap="hideEndModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-title">21å¤©å®éªŒç»“æŸ</view>
      <view class="modal-habit-name">{{endedHabit.name}}</view>
      <view class="modal-text">
        åœ¨è¿™21å¤©é‡Œ,ä½ åœ¨ <text class="highlight">{{endedHabit.completed_days}}/21</text> å¤©å®Œæˆäº†è¿™ä¸ªå¾®ä¹ æƒ¯,å®Œæˆç‡ <text class="highlight">{{endedHabit.completion_rate}}%</text>
      </view>

      <view class="modal-actions">
        <button class="btn btn-outline" bindtap="continueHabit">ç»§ç»­ä¸‹ä¸€è½®21å¤©</button>
        <button class="btn btn-text" bindtap="adjustHabit">æ”¹å°ä¸€ç‚¹</button>
        <button class="btn btn-text" bindtap="pauseHabit">å…ˆæš‚åœ</button>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ–°å»ºæŒ‰é’® -->
  <view class="fab" bindtap="goToCreate">
    <image src="/assets/icons/plus.png" mode="aspectFit" />
  </view>
</view>
